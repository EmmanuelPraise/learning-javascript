<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pillow Customizer Feature Extract (WebGL)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css">
    
    <style>
        #crop-container {
            height: 300px; /* Croppie requires a fixed height */
            width: 100%;
        }
        .pillow-mockup-area {
            height: 400px; /* Fixed height for the WebGL viewer */
        }
        /* Ensure the canvas fills the container */
        #pillow-3d-container canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style> 
</head>
<body class="bg-gray-100 p-8">

    <div class="product-customizer-app max-w-5xl mx-auto bg-white p-8 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Custom Image Product Builder (WebGL Preview)</h1>

        <div class="app-layout flex flex-col lg:flex-row gap-10 mt-8">
            
            <div class="customization-options lg:w-1/2">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600">1. Upload & Crop</h2>
                
                <input type="file" id="image-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                
                <div class="crop-module-container mt-5 p-5 border border-gray-300 rounded-lg bg-gray-50" style="display: none;">
                    <h3 class="text-xl font-medium mb-3 text-gray-700">Adjust Your Image</h3>
                    <div id="crop-container" class="mb-4"></div>
                    
                    <button id="crop-button" class="action-button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">
                        Apply Image to 3D Model
                    </button>
                    
                </div>
                
                <div class="size-controls mt-8 pt-4 border-t border-gray-200">
                    <h2 class="text-2xl font-semibold mb-4 text-indigo-600">2. Select Size</h2>
                    <label for="size-select" class="block text-gray-700 font-medium mb-2">Pillow Size:</label>
                    <select id="size-select" class="js-img-size w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="1.0x1.0">Square Pillow (1:1)</option>
                        <option value="1.5x1.0">Lumbar Pillow (1.5:1)</option>
                    </select>
                </div>
            </div>

            <div class="product-preview lg:w-1/2">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600">3. Final 3D Preview</h2>
                
                <div id="pillow-3d-container" class="pillow-mockup-area w-full border-4 border-gray-300 rounded-xl shadow-inner bg-white overflow-hidden relative">
                </div>
                
                <p id="size-message" class="info-message mt-3 text-indigo-600 italic"></p>
                <p id="webgl-status" class="info-message text-indigo-600 italic">Initializing 3D viewer...</p>

                </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const imageUpload = document.getElementById('image-upload');
        const cropModuleContainer = document.querySelector('.crop-module-container');
        const cropContainer = document.getElementById('crop-container');
        const cropButton = document.getElementById('crop-button');
        const pillowMockup = document.getElementById('pillow-3d-container');
        const sizeSelect = document.getElementById('size-select');
        const sizeMessage = document.getElementById('size-message');
        const webglStatus = document.getElementById('webgl-status');
        
        // Removed: removeBgButton, downloadSection, downloadCutoutLink

        let croppieInstance = null;
        let scene, camera, renderer, pillowMesh; // Three.js variables

        // --- WebGL Initialization ---
        function initWebGL() {
            // Basic Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0); // Light gray background
            
            // Camera
            camera = new THREE.PerspectiveCamera(75, pillowMockup.clientWidth / pillowMockup.clientHeight, 0.1, 1000);
            camera.position.z = 1.5;

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(pillowMockup.clientWidth, pillowMockup.clientHeight);
            pillowMockup.appendChild(renderer.domElement);

            // Lighting (MeshStandardMaterial requires good lighting)
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight1.position.set(2, 2, 2).normalize();
            scene.add(directionalLight1);
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight2.position.set(-2, -2, -2).normalize();
            scene.add(directionalLight2);

            // Initial 3D Pillow Object (A Simple Box)
            const geometry = new THREE.BoxGeometry(1.0, 1.0, 0.2); // Width, Height, Thickness
            const material = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.6, metalness: 0.1 }); // Default material
            pillowMesh = new THREE.Mesh(geometry, material);
            scene.add(pillowMesh);
            
            // Animation Loop (required for rendering)
            function animate() {
                requestAnimationFrame(animate);
                // Simple rotation for effect
                pillowMesh.rotation.y += 0.005;
                renderer.render(scene, camera);
            }
            animate();
            
            webglStatus.textContent = '3D viewer ready. Upload an image to apply the texture.';
        }

        // --- Core function to apply texture (simplified: only full image mode) ---
        function applyTextureToPillow(imageURI) {
            if (!pillowMesh) return;

            const loader = new THREE.TextureLoader();
            loader.load(imageURI, function(texture) {
                
                texture.colorSpace = THREE.SRGBColorSpace; 
                
                let imageMaterial = new THREE.MeshStandardMaterial({ 
                    map: texture, 
                    color: 0xffffff,
                    roughness: 0.8,
                    metalness: 0.1 
                });
                    
                let sideMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xcccccc, 
                    roughness: 0.7, 
                    metalness: 0.1 
                });

                // Material array for all 6 faces of the box
                const materials = [
                    sideMaterial,       // Right
                    sideMaterial,       // Left
                    sideMaterial,       // Top
                    sideMaterial,       // Bottom
                    imageMaterial,      // Front
                    imageMaterial,      // Back
                ];
                
                // Apply the new material to the pillow mesh
                pillowMesh.material = materials;
                pillowMesh.material.needsUpdate = true;
                webglStatus.textContent = 'Texture applied successfully! Rotating 3D Pillow.';
            });
        }

        // --- Update Pillow Mesh Size in 3D Scene ---
        function updatePillowMeshSize(width, height) {
            if (pillowMesh) {
                scene.remove(pillowMesh);

                const geometry = new THREE.BoxGeometry(width, height, 0.2);
                
                // Clone existing material(s) to maintain the texture/color if already applied
                const materials = pillowMesh.material.length ? pillowMesh.material.map(m => m.clone()) : [
                    new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.6, metalness: 0.1 })
                ];
                
                pillowMesh = new THREE.Mesh(geometry, materials);
                scene.add(pillowMesh);
            }
        }


        // --- Update Mockup and Cropper Size ---
        function updateMockupAndCropperSize(sizeValue) {
            const [ratioW, ratioH] = sizeValue.split('x').map(Number);
            updatePillowMeshSize(ratioW, ratioH);
            
            sizeMessage.textContent = `Selected Ratio: ${ratioW}:${ratioH}.`;
            
            // 2. Update the Croppie Viewport to match the new ratio
            const newCroppieHeight = 250 / (ratioW / ratioH);
            
            if (croppieInstance) {
                // Safely destroy and re-initialize croppie to update viewport size
                const currentImagePromise = croppieInstance.result({ type: 'base64' });
                croppieInstance.destroy();
                
                croppieInstance = new Croppie(cropContainer, {
                    viewport: { width: 250, height: newCroppieHeight, type: 'square' }, 
                    boundary: { width: 300, height: newCroppieHeight + 50 }, 
                    showZoomer: true,
                    enableResize: true,
                    enableOrientation: true
                });
                
                // Re-bind the current image if one exists
                currentImagePromise.then(uri => {
                    if (uri && uri.startsWith('data:image')) {
                        croppieInstance.bind({ url: uri });
                    }
                });
            }
        }

        // Initialize WebGL and Size Handler
        initWebGL();
        updateMockupAndCropperSize(sizeSelect.value);
        sizeSelect.addEventListener('change', (event) => {
            updateMockupAndCropperSize(event.target.value);
        });

        // --- File Upload Handler ---
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageURI = e.target.result;
                    const [ratioW, ratioH] = sizeSelect.value.split('x').map(Number);
                    const newCroppieHeight = 250 / (ratioW / ratioH);

                    if (croppieInstance) croppieInstance.destroy();
                    
                    croppieInstance = new Croppie(cropContainer, {
                        viewport: { width: 250, height: newCroppieHeight, type: 'square' }, 
                        boundary: { width: 300, height: newCroppieHeight + 50 }, 
                        showZoomer: true,
                        enableResize: true,
                        enableOrientation: true
                    });

                    croppieInstance.bind({ url: imageURI });
                    cropModuleContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                cropModuleContainer.style.display = 'none';
            }
        });


        // --- Apply Cropped Image as Full Texture ---
        cropButton.addEventListener('click', () => {
            if (!croppieInstance) return;

            croppieInstance.result({
                type: 'base64', 
                size: 'original',
                format: 'jpeg', // Use JPEG for smaller size/full-face
                quality: 0.9 
            }).then((croppedImageURI) => {
                applyTextureToPillow(croppedImageURI);
            });
        });
    });
    </script>
</body>
</html>